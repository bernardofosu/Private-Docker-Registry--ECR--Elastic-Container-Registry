# 🏗️ Setup Private Registry / ECR

## 1️⃣ Create AWS VM
```sh
sudo apt update

sudo install docker
```
**Add user to docker**
```sh
sudo usermod -aG docker ubuntu

sudo usermod -G docker ubuntu # It will replace all of ubuntu’s supplementary groups with just docker
```
- 🔹 Lowercase **-g** is used with `usermod` to **set a user’s primary group**  
- 🔹 Uppercase **-G** is used to **set supplementary (secondary) groups** for a user

---

## 2️⃣ Restart Shell for group membership to take place

**I) Log out & log back in**
- Ends the session so the new group membership applies.

**ii) Use `newgrp` (preferred)**
```sh
newgrp docker
```
- Switches your current shell to the `docker` group immediately.
- Starts a new shell session with updated group membership.
- Exit with `exit` to go back to the old session.

**Test Docker**
```sh
docker run hello-world
```

---

## 🔐 Create IAM User, Attach Policy & Configure AWS CLI
[Create IAM User, Attach Policy & Configure AWS CLI](./iam_user_ecr_setup.md)

```sh
aws configure
```

```sh
ls -la ~/.aws
cat ~/.aws/credentials
cat ~/.aws/config
aws configure list-profiles
```

---

## 3️⃣ Create private registry
[Create private registry](./2.%20private_ecr_setup.md)

**Retrieve an authentication token and authenticate your Docker client to your registry. Use the AWS CLI:**
```sh
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 440744234244.dkr.ecr.us-east-1.amazonaws.com
```

### 🔎 Where the Password Comes From
When you run:
```sh
aws ecr get-login-password --region us-east-1
```
- The AWS CLI calls the **ECR API (`GetAuthorizationToken`)**.  
- AWS generates a **temporary 12-hour token** that works as a password for Docker login.
- ✅ Password is **not hardcoded**.  
- 🔐 It comes from your **IAM credentials** (via AWS CLI).  
- 🔁 AWS gives you a **temporary token** every time you run the command.

**Build your Docker image using the following command. For information on building a Docker file from scratch see the instructions here**  
- You can skip this step if your image is already built:
```sh
docker build -t privatedockerregistry .
```
**After the build completes, tag your image so you can push the image to this repository:**
```sh
docker tag privatedockerregistry:latest 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:latest
```
**Run the following command to push this image to your newly created AWS repository:**
```sh
docker push 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:latest
```

---

## 🛠️ Pull hello world and push to ECR for learning
```sh
docker pull hello-world

docker images
```
**Output shows:**
```sh
REPOSITORY    TAG       IMAGE ID       CREATED       SIZE
hello-world   latest    1b44b5a3e06a   4 weeks ago   10.1kB
```

### 🔐 Authenticate Docker to ECR
Run:
```sh
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 440744234244.dkr.ecr.us-east-1.amazonaws.com
```
👉 This logs Docker into your private ECR registry.

### 🏷️ Tag the image for ECR
```sh
Replace <repo-name> with the name of the repository you created in ECR (e.g., test-repo).

docker tag hello-world:latest 440744234244.dkr.ecr.us-east-1.amazonaws.com/<repo-name>:latest

docker tag hello-world:latest 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:latest

# add another tag for the SAME image digest
docker tag hello-world:latest   440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:hello-world
```

**Now if you check:**
```sh
docker images
```
- This shows when the original image layer was built (by the publisher), not when you tagged it.
- In your case, the hello-world image itself was built by Docker Hub maintainers 4 weeks ago.

You’ll see two entries:
```sh
hello-world:latest

440744234244.dkr.ecr.us-east-1.amazonaws.com/<repo-name>:latest
```

### ⬆️ Push to ECR
```sh
docker push 440744234244.dkr.ecr.us-east-1.amazonaws.com/<repo-name>:latest

docker push 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:latest

docker push 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:hello-world
```

---

## 🐳 Let’s use our own image from Docker Hub
```sh
docker pull bofosu1/my-first-streamlit-crud:latest

docker images

docker tag bofosu1/my-first-streamlit-crud:latest 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:v1

docker push 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:v1
```

### 🗂️ How Docker tags work
- A **tag** is just a pointer (alias) to a single **image ID**.
- At any given time, a **tag can only reference one image ID**.

**If you tag two different images with the same tag:**
Example:
```sh
docker tag hello-world:latest myrepo:latest
docker tag streamlit-app:latest myrepo:latest
```
The second command **overwrites** the tag.
- Now `myrepo:latest` points only to `streamlit-app`’s image ID.
- The `hello-world` image is still there, but the tag no longer references it.

---

## ▶️ Run your Streamlit Docker image
```sh
docker run -d -p 8501:8501 <your-image-name>
```
- `-d` → detached mode (runs in background)
- `-p 8501:8501` → maps container port 8501 to host port 8501
- `<your-image-name>` → e.g. `bofosu1/my-first-streamlit-crud:latest` or your ECR repo name

### 🌍 Access the app
**If running locally** → open:
```sh
http://localhost:8501
```

**If running on a remote EC2 instance** → open in browser:
```sh
http://<EC2-public-IP>:8501
```
(✅ make sure port **8501** is allowed in your EC2 Security Group)

**⚡ Example with your ECR image:**
```sh
docker run -d -p 8501:8501 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:v1
```

---

## 🔑 Let’s check credentials
```sh
aws configure list
      Name                    Value             Type    Location
      ----                    -----             ----    --------
   profile                <not set>             None    None
access_key     ****************R2Y2 shared-credentials-file
secret_key     ****************q/vG shared-credentials-file
    region                us-east-1      config-file    ~/.aws/config
```

---

## ⬇️ We can also pull from ECR
```sh
docker pul 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:latest
```
> 📝 *Note: Command above preserves your original text. Correct form is:*  
> ```sh
> docker pull 440744234244.dkr.ecr.us-east-1.amazonaws.com/privatedockerregistry:latest
> ```

**If you get error then maybe token has expired and we have to login again**
```sh
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 440744234244.dkr.ecr.us-east-1.amazonaws.com
```

